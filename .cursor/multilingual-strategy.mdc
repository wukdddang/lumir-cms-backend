---
alwaysApply: true
---

# 다국어 콘텐츠 관리 전략

## 📋 개요

루미르 CMS에서 브로슈어, 전자공시 등 모든 다국어 콘텐츠는 **동일한 다국어 전략**을 따릅니다.

## 🌍 핵심 전략

### 1. 자동 다국어 지원

콘텐츠를 생성할 때, **전달받은 언어**와 **시스템에 등록된 모든 활성 언어**에 대해 자동으로 번역 레코드를 생성합니다.

```
예시: 한국어로 브로슈어 생성 시
- 한국어: 사용자가 입력한 제목/설명 (isSynced: false)
- 영어: 한국어 제목/설명 복사 (isSynced: true)
- 일본어: 한국어 제목/설명 복사 (isSynced: true)
- 중국어: 한국어 제목/설명 복사 (isSynced: true)
```

### 2. 번역 동기화 플래그 (isSynced)

각 번역 레코드는 `isSynced` 플래그를 가집니다:

| isSynced | 의미                           | 사용 시점                  |
| -------- | ------------------------------ | -------------------------- |
| `false`  | 개별 설정된 번역 (수동)        | 사용자가 직접 입력한 번역  |
| `true`   | 자동 동기화된 번역 (기준 복사) | 시스템이 자동 생성한 번역  |

### 3. 기준 언어 선정

자동 동기화 시 기준이 되는 번역은 다음 우선순위로 결정됩니다:

1. **한국어 (ko)** - 존재하면 한국어 우선
2. **첫 번째 번역** - 한국어가 없으면 사용자가 입력한 첫 번째 번역

## 🔄 생성 프로세스

### 단계별 흐름

```mermaid
flowchart TD
    Start([콘텐츠 생성 요청])
    Start --> ValidateLang[언어 ID 검증]
    ValidateLang --> CheckDup{중복 언어<br/>체크}
    CheckDup -->|중복 있음| Error1[400 에러]
    CheckDup -->|중복 없음| GetAllLang[모든 활성 언어<br/>조회]
    
    GetAllLang --> CreateContent[메인 콘텐츠 생성]
    CreateContent --> CreateCustom[사용자 입력 번역 생성<br/>isSynced: false]
    
    CreateCustom --> FindBase[기준 번역 찾기<br/>한국어 or 첫번째]
    FindBase --> CheckRemain{전달되지 않은<br/>언어 있나?}
    
    CheckRemain -->|있음| CreateSynced[자동 동기화 번역 생성<br/>isSynced: true]
    CheckRemain -->|없음| Complete
    CreateSynced --> Complete([생성 완료])
    
    style CreateCustom fill:#e1f5e1
    style CreateSynced fill:#fff4e1
    style Error1 fill:#ffe1e1
```

### 코드 예시 (브로슈어)

```typescript
// 1. 전달받은 언어들에 대한 번역 생성 (isSynced: false)
const customTranslations = data.translations.map((trans) =>
  this.translationRepository.create({
    brochureId: saved.id,
    languageId: trans.languageId,
    title: trans.title,
    description: trans.description || null,
    isSynced: false, // 개별 설정
    createdBy: data.createdBy,
  }),
);
await this.translationRepository.save(customTranslations);

// 2. 기준 번역 선정
const koreanLang = languages.find((l) => l.code === 'ko');
const baseTranslation =
  data.translations.find((t) => t.languageId === koreanLang?.id) ||
  data.translations[0];

// 3. 나머지 언어들에 대한 번역 생성 (isSynced: true)
const remainingLanguages = allLanguages.filter(
  (lang) => !languageIds.includes(lang.id),
);

if (remainingLanguages.length > 0) {
  const syncedTranslations = remainingLanguages.map((lang) =>
    this.translationRepository.create({
      brochureId: saved.id,
      languageId: lang.id,
      title: baseTranslation.title,
      description: baseTranslation.description || null,
      isSynced: true, // 자동 동기화
      createdBy: data.createdBy,
    }),
  );
  await this.translationRepository.save(syncedTranslations);
}
```

## 📝 수정 프로세스

### 번역 수정 시나리오

#### 시나리오 1: 개별 번역 수정 (isSynced: false → false)

```
상황: 영어 번역을 수정
결과: 해당 영어 번역만 업데이트, isSynced는 false 유지
```

#### 시나리오 2: 동기화된 번역 수정 (isSynced: true → false)

```
상황: 자동 생성된 일본어 번역을 수정
결과: 
- 일본어 번역 업데이트
- isSynced를 false로 변경 (이제 개별 관리됨)
```

#### 시나리오 3: 기준 번역 수정 + 자동 동기화

```
상황: 한국어(기준) 번역 수정
선택 1: 동기화된 번역 일괄 업데이트 (isSynced: true인 것들)
선택 2: 해당 번역만 수정 (자동 동기화 비활성화)
```

## 🎯 주요 검증 규칙

### 1. 언어 ID 검증

- 모든 번역의 `languageId`가 유효한지 확인
- 존재하지 않는 언어 ID면 400 에러

### 2. 중복 언어 체크

- 하나의 콘텐츠에 같은 언어가 중복되면 안 됨
- 중복 발견 시 400 에러

```typescript
// 중복 체크 로직
const languageIds = data.translations.map((t) => t.languageId);
const uniqueLanguageIds = new Set(languageIds);
if (uniqueLanguageIds.size !== languageIds.length) {
  throw new BadRequestException('중복된 언어 ID가 있습니다.');
}
```

### 3. 최소 번역 개수

- 최소 1개 이상의 번역 필요
- 번역이 없으면 400 에러

## 🔧 구현 체크리스트

### 필수 구현 항목

- ✅ **엔티티 구조**
  - [ ] 메인 엔티티 (Brochure, ElectronicDisclosure 등)
  - [ ] 번역 엔티티 (BrochureTranslation, ElectronicDisclosureTranslation 등)
  - [ ] `isSynced` boolean 필드

- ✅ **생성 로직**
  - [ ] 언어 ID 검증
  - [ ] 중복 언어 체크
  - [ ] 모든 활성 언어 조회
  - [ ] 사용자 입력 번역 생성 (isSynced: false)
  - [ ] 기준 번역 선정 (한국어 우선)
  - [ ] 나머지 언어 자동 번역 생성 (isSynced: true)

- ✅ **수정 로직**
  - [ ] 개별 번역 수정
  - [ ] isSynced 플래그 관리
  - [ ] (선택) 자동 동기화 업데이트

- ✅ **조회 로직**
  - [ ] 번역 포함 조회 (relations: ['translations'])
  - [ ] 언어별 필터링 지원

## 📊 데이터 구조

### 메인 엔티티 (공통)

```typescript
{
  id: uuid,
  isPublic: boolean,
  status: ContentStatus,
  order: number,
  attachments: jsonb | null,
  createdAt: timestamp,
  updatedAt: timestamp,
  deletedAt: timestamp | null,
  createdBy: uuid | null,
  updatedBy: uuid | null,
  version: number
}
```

### 번역 엔티티 (공통)

```typescript
{
  id: uuid,
  [contentName]Id: uuid,  // brochureId, electronicDisclosureId 등
  languageId: uuid,
  title: varchar(500),
  description: text | null,
  isSynced: boolean,  // 🔑 핵심 플래그
  createdAt: timestamp,
  updatedAt: timestamp,
  deletedAt: timestamp | null,
  createdBy: uuid | null,
  updatedBy: uuid | null,
  version: number
}
```

## 🌐 지원 언어 목록

시스템에 등록된 모든 활성 언어에 대해 자동으로 번역이 생성됩니다.

기본 언어:
- 🇰🇷 한국어 (ko) - 기본 기준 언어
- 🇺🇸 영어 (en)
- 🇯🇵 일본어 (ja)
- 🇨🇳 중국어 (zh)

추가 언어는 관리자가 `/api/admin/languages`를 통해 추가할 수 있습니다.

## 💡 장점

### 1. 완전한 다국어 지원
- 새로운 언어가 추가되어도 기존 콘텐츠가 자동으로 해당 언어를 지원
- 사용자는 원하는 언어만 입력하고 나머지는 시스템이 처리

### 2. 관리 편의성
- `isSynced` 플래그로 수동/자동 번역 구분
- 자동 번역은 필요시 개별 수정 가능

### 3. 데이터 일관성
- 모든 콘텐츠가 모든 활성 언어에 대한 번역을 가짐
- 특정 언어에서 콘텐츠가 누락되는 일 없음

### 4. 확장성
- 새로운 콘텐츠 타입 추가 시 동일한 패턴 재사용
- 번역 동기화 로직 중앙화 가능

## 🔄 자동 동기화 전략 (선택사항)

### 옵션 1: 수동 동기화

- 기본 전략
- `isSynced: true`인 번역은 그대로 유지
- 관리자가 필요시 개별 수정

### 옵션 2: 자동 동기화

- 기준 번역 수정 시 `isSynced: true`인 모든 번역 자동 업데이트
- 실시간 동기화 vs 백그라운드 동기화 선택 가능

```typescript
// 자동 동기화 예시
async 기준_번역_수정시_동기화(contentId: string, baseLanguageId: string) {
  // 기준 번역 조회
  const baseTranslation = await this.getBaseTranslation(contentId, baseLanguageId);
  
  // isSynced: true인 번역들 업데이트
  await this.translationRepository.update(
    {
      [contentType + 'Id']: contentId,
      isSynced: true,
    },
    {
      title: baseTranslation.title,
      description: baseTranslation.description,
      updatedAt: new Date(),
    }
  );
}
```

## 📚 적용 대상

이 전략은 다음 엔티티에 적용됩니다:

- ✅ **Brochure** (브로슈어) - 이미 구현됨
- ✅ **ElectronicDisclosure** (전자공시) - 구현 필요
- 🔄 **Announcement** (공지사항) - 향후 적용
- 🔄 **News** (뉴스) - 향후 적용
- 🔄 **IR** (IR 자료) - 향후 적용
- 🔄 **ShareholdersMeeting** (주주총회) - 향후 적용
- 🔄 **LumirStory** (루미르 스토리) - 향후 적용

## 🎓 참고 사항

1. **성능 고려사항**
   - 번역 레코드가 많아질 수 있으므로 인덱스 최적화 필요
   - `(contentId, languageId)` 복합 UNIQUE 인덱스 권장

2. **트랜잭션 관리**
   - 메인 콘텐츠 생성과 번역 생성은 하나의 트랜잭션으로 처리
   - 실패 시 롤백 보장

3. **버전 관리**
   - `version` 필드를 활용한 Optimistic Locking
   - 동시 수정 충돌 방지

4. **삭제 정책**
   - 메인 콘텐츠 삭제 시 번역도 CASCADE 삭제
   - Soft Delete 사용 권장
