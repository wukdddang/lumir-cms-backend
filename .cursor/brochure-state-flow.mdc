---
alwaysApply: true
---

# 브로슈어 데이터 상태 흐름 설계

## 📋 개요

브로슈어는 콘텐츠 관리 시스템의 핵심 엔티티로, **상태(Status)**와 **공개 여부(isPublic)** 두 가지 차원에서 관리됩니다.

## 🔄 상태(Status) 정의

브로슈어는 다음 5가지 상태를 가질 수 있습니다:

| 상태 | 값 | 설명 |
|------|-----|------|
| **초안** | `draft` | 작성 중인 상태, 아직 검토 요청 전 |
| **검토중** | `under_review` | 검토 요청 후 승인 대기 중 |
| **승인됨** | `approved` | 검토 완료, 승인된 상태 |
| **거부됨** | `rejected` | 검토 결과 거부된 상태 |
| **공개됨** | `opened` | 최종 공개된 상태 |

## 🔓 공개 여부(isPublic) 정의

| 값 | 설명 |
|----|------|
| `true` | 공개 상태 (사용자에게 노출) |
| `false` | 비공개 상태 (관리자만 조회 가능) |

## 📊 상태 전이 다이어그램

```
                    [생성]
                      ↓
                  [DRAFT]
                      ↓
            ┌─────────┴─────────┐
            ↓                   ↓
    [검토 요청]          [직접 수정/삭제]
            ↓
    [UNDER_REVIEW]
            ↓
    ┌───────┴───────┐
    ↓               ↓
[APPROVED]      [REJECTED]
    ↓               ↓
[공개 설정]      [수정 후 재검토]
    ↓
[OPENED]
```

## 🎯 상태별 상세 흐름

### 1. 초안 (DRAFT)

**설명**: 브로슈어가 생성되거나 수정 중인 상태

**가능한 액션**:
- ✅ 브로슈어 정보 수정 (제목, 설명, 번역 등)
- ✅ 파일 첨부/수정/삭제
- ✅ 카테고리 변경
- ✅ 정렬 순서 변경
- ✅ 공개 여부 변경 (isPublic)
- ✅ 삭제 (Soft Delete)
- ✅ **검토 요청** → `UNDER_REVIEW`로 전이

**제한 사항**:
- ❌ 공개 상태여도 사용자에게 노출되지 않음 (status가 `opened`가 아니면)

**API 엔드포인트**:
- `POST /api/admin/brochures` - 브로슈어 생성 (기본값: `status: 'draft'`)
- `PATCH /api/admin/brochures/:id/files` - 파일 수정
- `PATCH /api/admin/brochures/:id/categories` - 카테고리 수정
- `PATCH /api/admin/brochures/:id/order` - 정렬 순서 수정
- `PATCH /api/admin/brochures/:id/public` - 공개 여부 수정
- `DELETE /api/admin/brochures/:id` - 삭제

### 2. 검토중 (UNDER_REVIEW)

**설명**: 검토 요청이 제출되어 승인 대기 중인 상태

**가능한 액션**:
- ✅ 브로슈어 상세 조회
- ✅ **승인** → `APPROVED`로 전이
- ✅ **거부** → `REJECTED`로 전이
- ✅ **검토 취소** → `DRAFT`로 전이 (선택사항)

**제한 사항**:
- ❌ 내용 수정 불가 (검토 중에는 변경 불가)
- ❌ 삭제 불가 (검토 프로세스 진행 중)
- ❌ 공개 여부 변경 불가

**API 엔드포인트**:
- `GET /api/admin/brochures/:id` - 상세 조회
- `PATCH /api/admin/brochures/:id/status` - 상태 변경 (승인/거부) *(구현 필요)*

### 3. 승인됨 (APPROVED)

**설명**: 검토를 통과하여 승인된 상태

**가능한 액션**:
- ✅ 브로슈어 상세 조회
- ✅ **공개 설정** → `OPENED`로 전이
- ✅ **재검토 요청** → `UNDER_REVIEW`로 전이 (수정 후)
- ✅ 내용 수정 (수정 시 자동으로 `DRAFT`로 전이)
- ✅ 삭제

**제한 사항**:
- ⚠️ 공개 여부가 `true`여도 `status`가 `opened`가 아니면 사용자에게 노출되지 않음

**API 엔드포인트**:
- `GET /api/admin/brochures/:id` - 상세 조회
- `PATCH /api/admin/brochures/:id/public` - 공개 여부 변경
- `PATCH /api/admin/brochures/:id/status` - 상태 변경 (opened로) *(구현 필요)*
- `DELETE /api/admin/brochures/:id` - 삭제

### 4. 거부됨 (REJECTED)

**설명**: 검토 결과 거부된 상태

**가능한 액션**:
- ✅ 브로슈어 상세 조회
- ✅ **수정 후 재검토** → `DRAFT`로 전이 후 수정 → `UNDER_REVIEW`로 전이
- ✅ 삭제

**제한 사항**:
- ❌ 공개 불가 (거부된 콘텐츠는 공개할 수 없음)
- ❌ 승인 불가 (거부된 상태에서 바로 승인 불가)

**API 엔드포인트**:
- `GET /api/admin/brochures/:id` - 상세 조회
- `PATCH /api/admin/brochures/:id/status` - 상태 변경 (draft로) *(구현 필요)*
- `DELETE /api/admin/brochures/:id` - 삭제

### 5. 공개됨 (OPENED)

**설명**: 최종 승인되어 공개된 상태

**가능한 액션**:
- ✅ 브로슈어 상세 조회
- ✅ **비공개 처리** → `isPublic: false`로 변경 (상태는 유지)
- ✅ **내용 수정** → `DRAFT`로 전이 (공개된 콘텐츠 수정 시)
- ✅ 삭제 (Soft Delete)

**제한 사항**:
- ⚠️ 공개된 콘텐츠 수정 시 자동으로 `DRAFT`로 전이되어 사용자에게 노출 중단
- ⚠️ 삭제 시 Soft Delete로 처리 (데이터는 보존)

**API 엔드포인트**:
- `GET /api/admin/brochures/:id` - 상세 조회
- `PATCH /api/admin/brochures/:id/public` - 공개 여부 변경
- `DELETE /api/admin/brochures/:id` - 삭제

## 🔀 상태 전이 규칙

### 허용되는 전이

| 현재 상태 | 다음 상태 | 조건 |
|----------|----------|------|
| `draft` | `under_review` | 검토 요청 |
| `under_review` | `approved` | 승인 |
| `under_review` | `rejected` | 거부 |
| `under_review` | `draft` | 검토 취소 (선택사항) |
| `approved` | `opened` | 공개 설정 |
| `approved` | `draft` | 수정 시작 |
| `rejected` | `draft` | 수정 시작 |
| `opened` | `draft` | 수정 시작 |

### 금지되는 전이

- ❌ `draft` → `approved` (검토 없이 승인 불가)
- ❌ `draft` → `opened` (검토 및 승인 없이 공개 불가)
- ❌ `rejected` → `approved` (거부 후 바로 승인 불가)
- ❌ `rejected` → `opened` (거부된 콘텐츠 공개 불가)
- ❌ `under_review` → `opened` (검토 중 공개 불가)

## 🎨 공개 여부(isPublic)와 상태(Status)의 관계

### 사용자 노출 조건

브로슈어가 **사용자에게 노출**되려면 다음 조건을 모두 만족해야 합니다:

```
isPublic === true AND status === 'opened'
```

### 상태별 공개 여부 동작

| 상태 | isPublic | 사용자 노출 | 설명 |
|------|----------|------------|------|
| `draft` | `true` | ❌ | 초안은 공개 설정해도 노출 안 됨 |
| `draft` | `false` | ❌ | 비공개 초안 |
| `under_review` | `true` | ❌ | 검토 중은 노출 안 됨 |
| `under_review` | `false` | ❌ | 비공개 검토 중 |
| `approved` | `true` | ❌ | 승인되었지만 아직 공개 안 됨 |
| `approved` | `false` | ❌ | 비공개 승인 |
| `rejected` | `true` | ❌ | 거부된 콘텐츠는 노출 불가 |
| `rejected` | `false` | ❌ | 비공개 거부 |
| `opened` | `true` | ✅ | **공개됨 - 사용자에게 노출** |
| `opened` | `false` | ❌ | 공개 상태지만 비공개 설정 |

## 📝 상태 전이 시나리오

### 시나리오 1: 정상적인 공개 프로세스

```
1. 생성 (POST /api/admin/brochures)
   → status: 'draft', isPublic: true

2. 검토 요청 (PATCH /api/admin/brochures/:id/status → 'under_review')
   → status: 'under_review', isPublic: true

3. 승인 (PATCH /api/admin/brochures/:id/status → 'approved')
   → status: 'approved', isPublic: true

4. 공개 (PATCH /api/admin/brochures/:id/status → 'opened')
   → status: 'opened', isPublic: true
   → ✅ 사용자에게 노출됨
```

### 시나리오 2: 거부 후 재검토

```
1. 생성
   → status: 'draft'

2. 검토 요청
   → status: 'under_review'

3. 거부
   → status: 'rejected'

4. 수정 시작 (PATCH /api/admin/brochures/:id/status → 'draft')
   → status: 'draft'

5. 내용 수정 후 재검토 요청
   → status: 'under_review'

6. 승인
   → status: 'approved'

7. 공개
   → status: 'opened'
```

### 시나리오 3: 공개된 콘텐츠 수정

```
1. 공개된 상태
   → status: 'opened', isPublic: true
   → ✅ 사용자에게 노출 중

2. 내용 수정 시작
   → status: 'draft', isPublic: true
   → ❌ 사용자에게 노출 중단

3. 수정 완료 후 검토 요청
   → status: 'under_review'

4. 승인
   → status: 'approved'

5. 재공개
   → status: 'opened'
   → ✅ 사용자에게 다시 노출됨
```

## 🔧 구현 필요 사항

### 현재 구현된 기능

- ✅ 브로슈어 생성 (기본값: `status: 'draft'`)
- ✅ 브로슈어 목록 조회
- ✅ 브로슈어 상세 조회
- ✅ 공개 여부 수정 (`isPublic`)
- ✅ 파일 수정
- ✅ 카테고리 수정
- ✅ 정렬 순서 수정
- ✅ 삭제 (Soft Delete)

### 구현 필요 기능

- ⚠️ **상태 변경 API** (`PATCH /api/admin/brochures/:id/status`)
  - `draft` → `under_review` (검토 요청)
  - `under_review` → `approved` (승인)
  - `under_review` → `rejected` (거부)
  - `approved` → `opened` (공개)
  - `rejected` → `draft` (수정 시작)
  - `opened` → `draft` (수정 시작)

- ⚠️ **상태 전이 검증 로직**
  - 허용되지 않는 상태 전이 방지
  - 상태별 액션 제한 검증

- ⚠️ **사용자 노출 필터링**
  - 목록 조회 시 `status === 'opened' AND isPublic === true` 조건 필터링
  - 공개 API와 관리자 API 분리 (선택사항)

## 📌 비즈니스 규칙

### 규칙 1: 공개 조건

브로슈어가 사용자에게 노출되려면:
- `status`가 `opened`여야 함
- `isPublic`이 `true`여야 함
- `deletedAt`이 `null`이어야 함 (Soft Delete되지 않아야 함)

### 규칙 2: 상태 전이 제한

- 검토 없이 `draft`에서 `approved` 또는 `opened`로 전이 불가
- `rejected` 상태에서 바로 `approved` 또는 `opened`로 전이 불가
- `under_review` 상태에서는 내용 수정 불가

### 규칙 3: 공개된 콘텐츠 수정

- `opened` 상태의 브로슈어를 수정하면 자동으로 `draft`로 전이
- 수정 중에는 사용자에게 노출되지 않음
- 수정 완료 후 재검토 → 승인 → 공개 프로세스 필요

### 규칙 4: 삭제 정책

- 모든 상태에서 삭제 가능 (Soft Delete)
- 삭제된 브로슈어는 관리자 API에서도 기본적으로 조회되지 않음
- `deletedAt`이 설정되어 있으면 사용자에게 노출 불가

## 🎯 권장 워크플로우

### 관리자 워크플로우

```
1. 브로슈어 생성 (DRAFT)
   ↓
2. 내용 작성 및 파일 첨부
   ↓
3. 검토 요청 (UNDER_REVIEW)
   ↓
4. 검토자 승인/거부
   ├─ 승인 → APPROVED
   └─ 거부 → REJECTED → 수정 → 재검토
   ↓
5. 공개 설정 (OPENED)
   ↓
6. 사용자에게 노출
```

### 수정 워크플로우

```
1. 공개된 브로슈어 (OPENED)
   ↓
2. 수정 시작 (DRAFT로 전이)
   ↓
3. 내용 수정
   ↓
4. 검토 요청 (UNDER_REVIEW)
   ↓
5. 승인 (APPROVED)
   ↓
6. 재공개 (OPENED)
```

## 📚 참고 사항

- 상태 변경은 **원자적(Atomic)**으로 처리되어야 함
- 상태 전이 시 **이력 로깅** 고려 (선택사항)
- **Optimistic Locking** (`version` 필드)을 활용하여 동시 수정 방지
- 상태별 **권한 체크** 필요 (예: 승인 권한이 있는 사용자만 상태 변경 가능)
