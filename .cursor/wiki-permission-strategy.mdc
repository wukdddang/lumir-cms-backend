---
alwaysApply: true
---

# Wiki ê¶Œí•œ ê´€ë¦¬ ì „ëµ (Permission Cascading)

## ğŸ“‹ ê°œìš”

ë£¨ë¯¸ë¥´ CMSì˜ WikiëŠ” **ê³„ì¸µì  ê¶Œí•œ ê´€ë¦¬**ë¥¼ í†µí•´ í´ë” ê¸°ë°˜ì˜ ì ‘ê·¼ ì œì–´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

## ğŸ” í•µì‹¬ ì „ëµ

### 1. í´ë” ê¸°ë°˜ ê¶Œí•œ ì„¤ì •

**ê¶Œí•œì€ í´ë”ì—ë§Œ ì„¤ì •**í•˜ê³ , **íŒŒì¼ì˜ ê¶Œí•œì€ ìƒìœ„ í´ë”ì—ì„œ ìë™ìœ¼ë¡œ cascading**ë©ë‹ˆë‹¤.

```
ë£¨íŠ¸ í´ë” (ì „ì²´ ê³µê°œ)
  â””â”€â”€ ê°œë°œíŒ€ í´ë” (dev ë¶€ì„œë§Œ ê³µê°œ)
      â”œâ”€â”€ íšŒì˜ë¡.md (ê¶Œí•œ: dev ë¶€ì„œë§Œ - í´ë”ì—ì„œ ìƒì†)
      â””â”€â”€ ê¸°íšì„œ í´ë” (ì „ì²´ ê³µê°œë¡œ ì„¤ì •í•´ë„ dev ë¶€ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥)
          â””â”€â”€ ìš”êµ¬ì‚¬í•­.pdf (ê¶Œí•œ: dev ë¶€ì„œë§Œ - ê°€ì¥ ì œí•œì ì¸ ìƒìœ„ í´ë” ê¶Œí•œ ì ìš©)
```

### 2. ê¶Œí•œ Cascading ì›ì¹™

| í•­ëª©              | ì„¤ëª…                                                     |
| ----------------- | -------------------------------------------------------- |
| **í´ë”**          | `isPublic`, `permissionRankCodes`, `permissionPositionCodes`, `permissionDepartmentCodes` ì„¤ì • ê°€ëŠ¥ |
| **íŒŒì¼**          | ê¶Œí•œ í•„ë“œëŠ” í•­ìƒ `NULL` (ìƒìœ„ í´ë”ì—ì„œ ìë™ ê²°ì •)        |
| **ê³„ì¸µ ì²´í¬**     | ë£¨íŠ¸ë¶€í„° í˜„ì¬ ìœ„ì¹˜ê¹Œì§€ ëª¨ë“  ìƒìœ„ í´ë” ê¶Œí•œ ì²´í¬          |
| **ì œí•œì  ìš°ì„ **   | ìƒìœ„ í´ë” ì¤‘ í•˜ë‚˜ë¼ë„ ì œí•œì ì´ë©´ í•˜ìœ„ í•­ëª©ë„ ì œí•œë¨      |

### 3. ê¶Œí•œ íƒ€ì…

WikiëŠ” ì„¸ ê°€ì§€ ê¶Œí•œ ì²´ê³„ë¥¼ ì§€ì›í•©ë‹ˆë‹¤:

- **ì§ê¸‰ (Rank)**: `permissionRankCodes` - ì˜ˆ: `["manager", "general_manager"]`
- **ì§ì±… (Position)**: `permissionPositionCodes` - ì˜ˆ: `["team_leader"]`
- **ë¶€ì„œ (Department)**: `permissionDepartmentCodes` - ì˜ˆ: `["dev", "hr"]`

```typescript
// ê¶Œí•œ ì²´í¬ ë¡œì§ (OR ì¡°ê±´)
function hasAccess(folder, employee) {
  if (folder.isPublic) return true;
  
  return (
    folder.permissionRankCodes?.includes(employee.rankCode) ||
    folder.permissionPositionCodes?.includes(employee.positionCode) ||
    folder.permissionDepartmentCodes?.includes(employee.departmentCode)
  );
}
```

## ğŸ—ï¸ ì—”í‹°í‹° êµ¬ì¡°

### ë‹¨ì¼ ì—”í‹°í‹° (WikiFileSystem)

í˜„ì¬ êµ¬ì¡°ëŠ” **í•˜ë‚˜ì˜ ì—”í‹°í‹°**ë¡œ í´ë”ì™€ íŒŒì¼ì„ ëª¨ë‘ ê´€ë¦¬í•©ë‹ˆë‹¤.

```typescript
enum WikiFileSystemType {
  FOLDER = 'folder',
  FILE = 'file',
}

class WikiFileSystem {
  id: uuid;
  name: string;
  type: WikiFileSystemType; // 'folder' | 'file'
  parentId: uuid | null;    // ìê¸° ì°¸ì¡°
  depth: number;            // ê³„ì¸µ ê¹Šì´
  
  // íŒŒì¼ ì „ìš© í•„ë“œ (folderì¼ ë•ŒëŠ” NULL)
  title: string | null;
  content: text | null;
  fileUrl: string | null;
  fileSize: number | null;
  mimeType: string | null;
  attachments: jsonb | null;
  
  // ê¶Œí•œ í•„ë“œ (folderë§Œ ì‚¬ìš©, fileì€ í•­ìƒ NULL)
  isPublic: boolean;
  permissionRankCodes: jsonb | null;
  permissionPositionCodes: jsonb | null;
  permissionDepartmentCodes: jsonb | null;
  
  // ê³µí†µ í•„ë“œ
  order: number;
  createdAt: timestamp;
  updatedAt: timestamp;
  deletedAt: timestamp | null;
  createdBy: uuid | null;
  updatedBy: uuid | null;
  version: number;
}
```

### Closure Table (WikiFileSystemClosure)

ê³„ì¸µ êµ¬ì¡°ì˜ íš¨ìœ¨ì ì¸ ì¡°íšŒë¥¼ ìœ„í•´ Closure Table íŒ¨í„´ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

```typescript
class WikiFileSystemClosure {
  id: uuid;
  ancestor: uuid;    // ì¡°ìƒ ë…¸ë“œ
  descendant: uuid;  // ìì† ë…¸ë“œ
  depth: number;     // ê³„ì¸µ ê¹Šì´
}
```

**ì¥ì **:
- ëª¨ë“  ì¡°ìƒ ë…¸ë“œë¥¼ í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ ì¡°íšŒ ê°€ëŠ¥
- ê¶Œí•œ Cascading êµ¬í˜„ ë‹¨ìˆœ
- ê³„ì¸µ ì´ë™/ì‚­ì œ ì‹œ ì„±ëŠ¥ ìš°ìˆ˜

## ğŸ”„ ê¶Œí•œ ì²´í¬ í”„ë¡œì„¸ìŠ¤

```mermaid
flowchart TD
    Start([íŒŒì¼/í´ë” ì ‘ê·¼ ìš”ì²­])
    Start --> GetItem[ëŒ€ìƒ í•­ëª© ì¡°íšŒ]
    GetItem --> GetAncestors[Closure Tableë¡œ<br/>ëª¨ë“  ì¡°ìƒ í´ë” ì¡°íšŒ]
    
    GetAncestors --> LoopStart{ì¡°ìƒ í´ë”<br/>ìˆœíšŒ ì‹œì‘}
    LoopStart --> CheckPublic{í´ë”ê°€<br/>ì „ì²´ ê³µê°œ?}
    
    CheckPublic -->|Yes| NextFolder[ë‹¤ìŒ í´ë”]
    CheckPublic -->|No| CheckPermission{ì§ê¸‰/ì§ì±…/ë¶€ì„œ<br/>ê¶Œí•œ ìˆìŒ?}
    
    CheckPermission -->|Yes| NextFolder
    CheckPermission -->|No| Deny[ì ‘ê·¼ ê±°ë¶€]
    
    NextFolder --> MoreFolders{ë” í™•ì¸í• <br/>í´ë” ìˆìŒ?}
    MoreFolders -->|Yes| CheckPublic
    MoreFolders -->|No| Allow[ì ‘ê·¼ í—ˆìš©]
    
    style Allow fill:#e1f5e1
    style Deny fill:#ffe1e1
    style GetAncestors fill:#e1f0ff
```

### ê¶Œí•œ ì²´í¬ ì½”ë“œ ì˜ˆì‹œ

```typescript
/**
 * ìœ„í‚¤ í•­ëª©ì˜ ì ‘ê·¼ ê¶Œí•œì„ ì²´í¬í•œë‹¤ (Cascading)
 */
async ì ‘ê·¼_ê¶Œí•œì„_ì²´í¬í•œë‹¤(
  wikiId: string,
  employee: {
    id: string;
    rankCode?: string;
    positionCode?: string;
    departmentCode?: string;
  },
): Promise<boolean> {
  // Closure Tableë¡œ í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ ëª¨ë“  ì¡°ìƒ í´ë” ì¡°íšŒ
  const ancestorFolders = await this.closureRepository
    .createQueryBuilder('closure')
    .innerJoinAndSelect('closure.ancestorNode', 'wiki')
    .where('closure.descendant = :wikiId', { wikiId })
    .andWhere('wiki.type = :type', { type: WikiFileSystemType.FOLDER })
    .andWhere('wiki.deletedAt IS NULL')
    .orderBy('closure.depth', 'DESC') // ë£¨íŠ¸ë¶€í„° ìˆœì„œëŒ€ë¡œ
    .getMany();

  // ë£¨íŠ¸ë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ê¶Œí•œ ì²´í¬ (Cascading)
  for (const closure of ancestorFolders) {
    const folder = closure.ancestorNode;

    // ì „ì²´ ê³µê°œë©´ í†µê³¼
    if (folder.isPublic) {
      continue;
    }

    // ì œí•œ ê³µê°œì¸ ê²½ìš° ê¶Œí•œ ì²´í¬ (OR ì¡°ê±´)
    const hasAccess =
      (folder.permissionRankCodes &&
        employee.rankCode &&
        folder.permissionRankCodes.includes(employee.rankCode)) ||
      (folder.permissionPositionCodes &&
        employee.positionCode &&
        folder.permissionPositionCodes.includes(employee.positionCode)) ||
      (folder.permissionDepartmentCodes &&
        employee.departmentCode &&
        folder.permissionDepartmentCodes.includes(employee.departmentCode));

    if (!hasAccess) {
      return false; // ìƒìœ„ í´ë”ì— ì ‘ê·¼ ë¶ˆê°€í•˜ë©´ í•˜ìœ„ë„ ì ‘ê·¼ ë¶ˆê°€
    }
  }

  return true;
}
```

## ğŸ“ ìƒì„± í”„ë¡œì„¸ìŠ¤

### í´ë” ìƒì„±

```typescript
// í´ë”ëŠ” ê¶Œí•œ ì„¤ì • ê°€ëŠ¥
async í´ë”ë¥¼_ìƒì„±í•œë‹¤(data: {
  name: string;
  parentId?: string | null;
  isPublic?: boolean;
  permissionRankCodes?: string[] | null;
  permissionPositionCodes?: string[] | null;
  permissionDepartmentCodes?: string[] | null;
  order?: number;
  createdBy?: string;
}): Promise<WikiFileSystem> {
  const folder = this.wikiRepository.create({
    name: data.name,
    type: WikiFileSystemType.FOLDER,
    parentId: data.parentId || null,
    // ê¶Œí•œ ì„¤ì •
    isPublic: data.isPublic ?? true,
    permissionRankCodes: data.permissionRankCodes || null,
    permissionPositionCodes: data.permissionPositionCodes || null,
    permissionDepartmentCodes: data.permissionDepartmentCodes || null,
    order: data.order ?? 0,
    createdBy: data.createdBy,
  });

  return await this.wikiRepository.save(folder);
}
```

### íŒŒì¼ ìƒì„±

```typescript
// íŒŒì¼ì€ ê¶Œí•œ ì„¤ì • ì—†ìŒ (ìƒìœ„ í´ë”ì—ì„œ cascading)
async íŒŒì¼ì„_ìƒì„±í•œë‹¤(data: {
  name: string;
  parentId?: string | null;
  title?: string | null;
  content?: string | null;
  attachments?: Array<{
    fileName: string;
    fileUrl: string;
    fileSize: number;
    mimeType: string;
  }> | null;
  order?: number;
  createdBy?: string;
}): Promise<WikiFileSystem> {
  const file = this.wikiRepository.create({
    name: data.name,
    type: WikiFileSystemType.FILE,
    parentId: data.parentId || null,
    title: data.title || null,
    content: data.content || null,
    attachments: data.attachments || null,
    // íŒŒì¼ì€ ê¶Œí•œ í•„ë“œ ì‚¬ìš© ì•ˆí•¨ (í´ë”ì—ì„œ cascading)
    isPublic: true, // ê¸°ë³¸ê°’ (ì‹¤ì œë¡œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŒ)
    permissionRankCodes: null,
    permissionPositionCodes: null,
    permissionDepartmentCodes: null,
    order: data.order ?? 0,
    createdBy: data.createdBy,
  });

  return await this.wikiRepository.save(file);
}
```

## ğŸ¯ ì£¼ìš” ê²€ì¦ ê·œì¹™

### 1. í´ë” ê¶Œí•œ ê²€ì¦

```typescript
// CHECK ì œì•½ì¡°ê±´: í´ë”ì˜ ì œí•œê³µê°œ ì‹œ ìµœì†Œ í•˜ë‚˜ì˜ ê¶Œí•œ í•„ë“œ í•„ìš”
ALTER TABLE wiki_file_system ADD CONSTRAINT chk_wiki_folder_permissions
  CHECK (
    (type = 'file') OR
    (type = 'folder' AND is_public = true) OR
    (type = 'folder' AND is_public = false AND (
      jsonb_array_length(permission_rank_codes) > 0 OR
      jsonb_array_length(permission_position_codes) > 0 OR
      jsonb_array_length(permission_department_codes) > 0
    ))
  );
```

### 2. íŒŒì¼ ê¶Œí•œ ê²€ì¦

```typescript
// CHECK ì œì•½ì¡°ê±´: íŒŒì¼ì€ ê¶Œí•œ í•„ë“œê°€ ëª¨ë‘ NULL
ALTER TABLE wiki_file_system ADD CONSTRAINT chk_wiki_file_no_permissions
  CHECK (
    (type = 'folder') OR
    (type = 'file' AND 
      permission_rank_codes IS NULL AND 
      permission_position_codes IS NULL AND 
      permission_department_codes IS NULL
    )
  );
```

### 3. í´ë”/íŒŒì¼ íƒ€ì…ë³„ í•„ë“œ ê²€ì¦

```typescript
// folderëŠ” ëª¨ë“  íŒŒì¼ ê´€ë ¨ í•„ë“œê°€ NULL
ALTER TABLE wiki_file_system ADD CONSTRAINT chk_wiki_folder_fields
  CHECK (
    (type = 'folder' AND title IS NULL AND content IS NULL 
      AND file_url IS NULL AND attachments IS NULL) OR
    (type = 'file')
  );

// fileì€ title, content, fileUrl, attachments ì¤‘ ìµœì†Œ í•˜ë‚˜ í•„ìš”
ALTER TABLE wiki_file_system ADD CONSTRAINT chk_wiki_file_has_content
  CHECK (
    (type = 'folder') OR
    (type = 'file' AND (
      title IS NOT NULL OR
      content IS NOT NULL OR
      file_url IS NOT NULL OR
      attachments IS NOT NULL
    ))
  );
```

## ğŸ”§ êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### í•„ìˆ˜ êµ¬í˜„ í•­ëª©

- âœ… **ì—”í‹°í‹° êµ¬ì¡°**
  - [x] WikiFileSystem ì—”í‹°í‹° (í´ë” + íŒŒì¼)
  - [x] WikiFileSystemClosure (Closure Table)
  - [x] WikiPermissionLog (ê¶Œí•œ ë³€ê²½ ì´ë ¥)
  - [x] CHECK ì œì•½ì¡°ê±´ (íƒ€ì…ë³„ í•„ë“œ ê²€ì¦)

- âœ… **ê¶Œí•œ ë¡œì§**
  - [x] í´ë” ê¶Œí•œ ì„¤ì • (isPublic, permissionCodes)
  - [x] íŒŒì¼ ê¶Œí•œ í•„ë“œ NULL ê°•ì œ
  - [x] Cascading ê¶Œí•œ ì²´í¬ ë©”ì„œë“œ
  - [x] Closure Table í™œìš© ì¡°ìƒ ì¡°íšŒ

- âœ… **ìƒì„± ë¡œì§**
  - [x] í´ë” ìƒì„± (ê¶Œí•œ ì„¤ì • í¬í•¨)
  - [x] íŒŒì¼ ìƒì„± (ê¶Œí•œ ì„¤ì • ì—†ìŒ)
  - [x] Closure Table ìë™ ê´€ë¦¬
  - [x] íŒŒì¼ ì—…ë¡œë“œ (AWS S3)

- âœ… **ìˆ˜ì • ë¡œì§**
  - [x] í´ë” ê¶Œí•œ ìˆ˜ì •
  - [ ] íŒŒì¼ ê²½ë¡œ ì´ë™ ì‹œ ê¶Œí•œ ì¬ê²€ì¦
  - [x] íŒŒì¼ ì²¨ë¶€íŒŒì¼ êµì²´

- âœ… **ì¡°íšŒ ë¡œì§**
  - [ ] ì‚¬ìš©ìë³„ ì ‘ê·¼ ê°€ëŠ¥í•œ í•­ëª©ë§Œ ì¡°íšŒ
  - [x] ê³„ì¸µ êµ¬ì¡° ì¡°íšŒ (Closure Table)
  - [x] ìƒìœ„ ê²½ë¡œ ì¡°íšŒ (Breadcrumb)

- âœ… **ì‚­ì œ ë¡œì§**
  - [x] í´ë” ì‚­ì œ (í•˜ìœ„ í•­ëª© í¬í•¨)
  - [x] í´ë”ë§Œ ì‚­ì œ (í•˜ìœ„ í•­ëª© ìœ ì§€)
  - [x] Soft Delete

## ğŸ’¡ ë‹¨ì¼ ì—”í‹°í‹° vs ì—”í‹°í‹° ë¶„ë¦¬

### í˜„ì¬ êµ¬ì¡°: ë‹¨ì¼ ì—”í‹°í‹° (WikiFileSystem)

#### âœ… ì¥ì 

1. **ê³„ì¸µ êµ¬ì¡° ê´€ë¦¬ ë‹¨ìˆœ**
   - `parentId` í•˜ë‚˜ë¡œ í´ë”/íŒŒì¼ êµ¬ë¶„ ì—†ì´ ê³„ì¸µ ê´€ë¦¬
   - Closure Table êµ¬ì¡° ë‹¨ìˆœ (í•˜ë‚˜ì˜ í…Œì´ë¸”ë§Œ)

2. **ê¶Œí•œ Cascading êµ¬í˜„ ë‹¨ìˆœ**
   - ìƒìœ„ í´ë” ì¡°íšŒê°€ ë‹¨ìˆœ (íƒ€ì… í•„í„°ë§Œ ì¶”ê°€)
   - JOIN ì—†ì´ í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ ì¡°ìƒ ì¡°íšŒ

3. **ì„±ëŠ¥ ìš°ìˆ˜**
   - íŒŒì¼/í´ë” í˜¼í•© ì¡°íšŒ ì‹œ JOIN ë¶ˆí•„ìš”
   - ì¸ë±ìŠ¤ ì „ëµ ë‹¨ìˆœ (í•˜ë‚˜ì˜ í…Œì´ë¸”)

4. **ì´ë™ ìš©ì´**
   - íŒŒì¼ê³¼ í´ë”ë¥¼ ë™ì¼í•œ ê³„ì¸µì—ì„œ ê´€ë¦¬
   - ê²½ë¡œ ë³€ê²½ ì‹œ ë¡œì§ ë‹¨ìˆœ

5. **PostgreSQL TOAST**
   - `text`, `jsonb` í•„ë“œëŠ” TOASTë¡œ ë³„ë„ ì €ì¥
   - NULL í•„ë“œëŠ” ê³µê°„ ë‚­ë¹„ ìµœì†Œ

#### âš ï¸ ë‹¨ì 

1. **ì—”í‹°í‹° í¬ê¸°**
   - í•„ë“œ ìˆ˜ê°€ ë§ìŒ (ê³µí†µ + í´ë” ì „ìš© + íŒŒì¼ ì „ìš©)
   - NULL í•„ë“œê°€ ë§ìŒ (í´ë”ëŠ” íŒŒì¼ í•„ë“œ NULL, íŒŒì¼ì€ ê¶Œí•œ í•„ë“œ NULL)

2. **íƒ€ì…ë³„ ë¡œì§ ë¶„ê¸°**
   - ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ íƒ€ì… ì²´í¬ í•„ìš”
   - íƒ€ì…ë³„ ê²€ì¦ ë¡œì§ ë³µì¡

3. **ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì˜í–¥**
   - í•œìª½ íƒ€ì…ì˜ í•„ë“œ ì¶”ê°€ ì‹œ ì „ì²´ í…Œì´ë¸” ì˜í–¥

### ëŒ€ì•ˆ: ì—”í‹°í‹° ë¶„ë¦¬ (WikiFolder + WikiFile)

#### âœ… ì¥ì 

1. **ì±…ì„ ëª…í™•**
   - ê° ì—”í‹°í‹°ê°€ ìì‹ ì˜ ì—­í• ì— ì§‘ì¤‘
   - NULL í•„ë“œ ì—†ìŒ

2. **íƒ€ì… ì•ˆì „ì„±**
   - íƒ€ì…ë³„ ê²€ì¦ ë¡œì§ ë‹¨ìˆœ
   - ì˜ëª»ëœ í•„ë“œ ì¡°í•© ë¶ˆê°€ëŠ¥

3. **ë…ë¦½ì  í™•ì¥**
   - íŒŒì¼ íƒ€ì… í™•ì¥ ì‹œ WikiFileë§Œ ìˆ˜ì •
   - í´ë” ê¸°ëŠ¥ ì¶”ê°€ ì‹œ WikiFolderë§Œ ìˆ˜ì •

#### âš ï¸ ë‹¨ì 

1. **ê³„ì¸µ êµ¬ì¡° ë³µì¡**
   - `parentId`ê°€ WikiFolderì™€ WikiFileì„ ëª¨ë‘ ì°¸ì¡°
   - ë‹¤í˜• ê´€ê³„ (Polymorphic) í•„ìš”

2. **Closure Table ë³µì¡**
   - ë‘ ì—”í‹°í‹°ë¥¼ ë™ì‹œì— ê´€ë¦¬í•´ì•¼ í•¨
   - ì¡°ìƒ ì¡°íšŒ ì‹œ ë‘ í…Œì´ë¸” UNION í•„ìš”

3. **ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥**
   - íŒŒì¼/í´ë” í˜¼í•© ì¡°íšŒ ì‹œ JOIN ë˜ëŠ” UNION í•„ìš”
   - ì¸ë±ìŠ¤ ì „ëµ ë³µì¡

4. **ì´ë™ ë¡œì§ ë³µì¡**
   - íŒŒì¼ê³¼ í´ë”ì˜ ê²½ë¡œ ë³€ê²½ ë¡œì§ ë³„ë„ ê´€ë¦¬

## ğŸ“ ê¶Œì¥ ì‚¬í•­

### ë‹¨ì¼ ì—”í‹°í‹° ìœ ì§€ ê¶Œì¥

í˜„ì¬ ìƒí™©ì—ì„œëŠ” **ë‹¨ì¼ ì—”í‹°í‹° (WikiFileSystem)ë¥¼ ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤**.

#### ì´ìœ 

1. **ê¶Œí•œ Cascading êµ¬ì¡°**
   - í´ë”ë§Œ ê¶Œí•œì„ ê°€ì§€ê³  íŒŒì¼ì€ ìƒì†ë°›ëŠ” êµ¬ì¡°
   - í•˜ë‚˜ì˜ ì—”í‹°í‹°ë¡œ ê³„ì¸µì„ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ í›¨ì”¬ ë‹¨ìˆœ

2. **ê³„ì¸µ êµ¬ì¡° ë³µì¡ë„**
   - WikiëŠ” í´ë”ì™€ íŒŒì¼ì´ ê¹Šê²Œ ì¤‘ì²©ë¨
   - Closure Tableê³¼ ê²°í•© ì‹œ ë‹¨ì¼ ì—”í‹°í‹°ê°€ ìœ ë¦¬

3. **ì¡°íšŒ ì„±ëŠ¥**
   - íŒŒì¼/í´ë” í˜¼í•© ì¡°íšŒê°€ ë¹ˆë²ˆí•¨ (ëª©ë¡, ê²€ìƒ‰)
   - JOIN/UNION ì—†ì´ ì¡°íšŒ ê°€ëŠ¥

4. **í•„ë“œ ì¤‘ë³µë„ ë‚®ìŒ**
   - í´ë”/íŒŒì¼ ê³µí†µ í•„ë“œê°€ ë§ìŒ (name, order, created ë“±)
   - íƒ€ì…ë³„ ì „ìš© í•„ë“œëŠ” ì†Œìˆ˜

5. **CHECK ì œì•½ì¡°ê±´**
   - ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ íƒ€ì…ë³„ í•„ë“œ ê²€ì¦ ê°€ëŠ¥
   - ì˜ëª»ëœ ë°ì´í„° ì…ë ¥ ë°©ì§€

### ì—”í‹°í‹° ë¶„ë¦¬ ê³ ë ¤ ì‹œì 

ë‹¤ìŒ ìƒí™©ì—ì„œëŠ” ì—”í‹°í‹° ë¶„ë¦¬ë¥¼ ê³ ë ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- âŒ íŒŒì¼ íƒ€ì…ì´ ë§¤ìš° ë‹¤ì–‘í•´ì§ˆ ë•Œ (ë¬¸ì„œí˜•, ë¯¸ë””ì–´í˜•, ë§í¬í˜•, ì„ë² ë“œí˜• ë“±)
- âŒ íŒŒì¼ê³¼ í´ë”ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì™„ì „íˆ ë…ë¦½ì ì¼ ë•Œ
- âŒ ê° íƒ€ì…ì˜ ì „ìš© í•„ë“œê°€ 10ê°œ ì´ìƒ ì¶”ê°€ë  ë•Œ
- âŒ íŒŒì¼/í´ë” í˜¼í•© ì¡°íšŒê°€ ê±°ì˜ ì—†ì„ ë•Œ

## ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤

### ê¶Œì¥ ì¸ë±ìŠ¤

```sql
-- 1. ê¸°ë³¸ ì¡°íšŒ (ë¶€ëª¨ ID + íƒ€ì…)
CREATE INDEX idx_wiki_parent_type ON wiki_file_system (parent_id, type, deleted_at);

-- 2. ì •ë ¬ (ë¶€ëª¨ ID + ìˆœì„œ)
CREATE INDEX idx_wiki_parent_order ON wiki_file_system (parent_id, "order", deleted_at);

-- 3. ê¶Œí•œ ì²´í¬ (Closure Table)
CREATE INDEX idx_wiki_closure_descendant ON wiki_file_system_closure (descendant, depth);
CREATE INDEX idx_wiki_closure_ancestor ON wiki_file_system_closure (ancestor, depth);

-- 4. ê²€ìƒ‰ (ì´ë¦„)
CREATE INDEX idx_wiki_name ON wiki_file_system USING gin (name gin_trgm_ops);

-- 5. ê¶Œí•œ í•„í„°ë§ (JSONB)
CREATE INDEX idx_wiki_permission_ranks ON wiki_file_system USING gin (permission_rank_codes);
CREATE INDEX idx_wiki_permission_positions ON wiki_file_system USING gin (permission_position_codes);
CREATE INDEX idx_wiki_permission_departments ON wiki_file_system USING gin (permission_department_codes);
```

## ğŸ”„ í™•ì¥ ê°€ëŠ¥ì„±

### í–¥í›„ ê¸°ëŠ¥ ì¶”ê°€ ì‹œë‚˜ë¦¬ì˜¤

#### 1. íŒŒì¼ íƒ€ì… í™•ì¥

í˜„ì¬ëŠ” ë¬¸ì„œí˜•ê³¼ ì²¨ë¶€íŒŒì¼í˜•ë§Œ ì§€ì›í•˜ì§€ë§Œ, í–¥í›„ ë‹¤ìŒê³¼ ê°™ì€ íƒ€ì… ì¶”ê°€ ê°€ëŠ¥:

```typescript
// ì˜µì…˜ 1: í•„ë“œ ì¶”ê°€ (ë‹¨ì¼ ì—”í‹°í‹° ìœ ì§€)
class WikiFileSystem {
  // ê¸°ì¡´ í•„ë“œ...
  linkUrl: string | null;        // ë§í¬í˜•
  embedCode: text | null;        // ì„ë² ë“œí˜•
  mediaType: string | null;      // ë¯¸ë””ì–´í˜• (video, audio, image)
}

// ì˜µì…˜ 2: ì„œë¸Œíƒ€ì… ì¶”ê°€ (ì—”í‹°í‹° ë¶„ë¦¬)
enum WikiFileType {
  DOCUMENT = 'document',
  ATTACHMENT = 'attachment',
  LINK = 'link',
  EMBED = 'embed',
  MEDIA = 'media',
}
```

**ê¶Œì¥**: ì˜µì…˜ 1 (í•„ë“œ ì¶”ê°€) - ë‹¨ì¼ ì—”í‹°í‹° ìœ ì§€

#### 2. ê¶Œí•œ ì„¸ë¶„í™”

í˜„ì¬ëŠ” OR ì¡°ê±´ì´ì§€ë§Œ, í–¥í›„ AND ì¡°ê±´ì´ë‚˜ ë³µí•© ì¡°ê±´ ì¶”ê°€ ê°€ëŠ¥:

```typescript
interface WikiPermission {
  mode: 'OR' | 'AND';  // ê¶Œí•œ ì²´í¬ ëª¨ë“œ
  rules: Array<{
    type: 'rank' | 'position' | 'department';
    codes: string[];
    required: boolean;  // í•„ìˆ˜ ì—¬ë¶€
  }>;
}
```

#### 3. ë²„ì „ ê´€ë¦¬

ë¬¸ì„œ í¸ì§‘ ì´ë ¥ ê´€ë¦¬ë¥¼ ìœ„í•œ ë²„ì „ ê´€ë¦¬ ì¶”ê°€ ê°€ëŠ¥:

```typescript
class WikiFileVersion {
  id: uuid;
  wikiFileId: uuid;
  version: number;
  title: string;
  content: text;
  changedBy: uuid;
  changedAt: timestamp;
}
```

## ğŸ“š ì°¸ê³  ì‚¬í•­

1. **Closure Table ìœ ì§€ë³´ìˆ˜**
   - í´ë”/íŒŒì¼ ì´ë™ ì‹œ Closure Table ìë™ ì—…ë°ì´íŠ¸ í•„ìˆ˜
   - ìˆœí™˜ ì°¸ì¡° ì²´í¬ ë¡œì§ í•„ìš”

2. **ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§**
   - ê¹Šì€ ê³„ì¸µ êµ¬ì¡° ì‹œ Cascading ê¶Œí•œ ì²´í¬ ì„±ëŠ¥ ì¸¡ì •
   - í•„ìš” ì‹œ ê¶Œí•œ ê²°ê³¼ ìºì‹± ê³ ë ¤

3. **ê¶Œí•œ ë³€ê²½ ì´ë ¥**
   - WikiPermissionLogë¡œ ê¶Œí•œ ë³€ê²½ ì´ë ¥ ì¶”ì 
   - ê°ì‚¬(Audit) ëª©ì 

4. **íŠ¸ëœì­ì…˜ ê´€ë¦¬**
   - Closure Table ì—…ë°ì´íŠ¸ëŠ” í•­ìƒ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì²˜ë¦¬
   - ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ë³´ì¥
